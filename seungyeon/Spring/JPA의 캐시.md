# JPA의 캐시

### 캐시

동일한 데이터에 반복해서 접근. 많은 연산이 필요할 때 결과를 빠르게 이용하고자 성능 좋은 , 가까운 곳에 저장

### 1차 캐시

영속성 컨텍스트 내부의 엔티티 보관 장소

- 영속성 컨텍스트 자체가 1차 캐시
- 엔티티 매니저로 조회하거나 변경하는 모든 엔티티는 1차 캐시에 저장
- 트랜잭션 커밋, 플러시 호출 하면 1차 캐시의 엔티티 변경 내역을 DB에 동기화
- 트랜잭션을 시작하고 종료할 때까지만 1차 캐시 유효
    
    → 애플리케이션 전체로 보면 접근 횟수를 획기적으로 줄일 수 없음
    
- 트랜잭션 시작/종료 할 때 영속성 컨텍스트도 시작/종료
- 동일한 트랜잭션 내에서만 1차 캐시가 존재하기 때문에 이미 1차 캐시에 저장 되어있는 경우는 흔치 않음

### 2차 캐시 = 공유캐시

애플리케이션 종료할 때까지 유지. 

- 2차 캐시 적용하면 데이터 조회 시 우선 2차 캐시에서 찾고 없으면 DB에서 찾음
    
    → 2차 캐시 활용하면 DB 조회 횟수를 획기적으로 줄일 수 있음
    
- 1차 → 2차 → DB
- **2차 캐시는 동시성을 극대화하기 위해 캐시한 객체를 직접 반환하지 않고 복사본을 만들어 반환**
    
    → 그대로 반환하면 동시에 여러곳에서 같은 객체 수정할 수 있는데. 이 때 락을 걸면 동시성이 떨어짐.
    
    → 이에 비해 복사본을 만드는 비용이 훨씬 저렴함
    
- 2차 캐시는 애플리케이션 범위의 캐시이기에 DB 조회가 1차 캐시만 사용할 때보다 획기적으로 줄어듬